---
title: 微服务架构要点
tags:
---

微服务架构并不复杂，本质上是一个实践性、工程性很强的，也有少许理论性。大部分人没有足够的架构经验，以下是我提炼的一些要点：

分布式事务、服务平滑上下线、全链路跟踪、监控报警、限流降级、灰度发布、服务网关。其中一些已经有很好的解决方案，今天主要说两个容易被忽略的事协议设计和分布式事务。

## 协议设计

越靠近前端的协议越要严谨的设计，因为产品一旦发布你**没有后悔的机会**。你始终要保证老版本的可用性。这里也要考虑将来协议是否会切换？比如架构的调整。要考虑协议的扩展性和向下兼容性。总体来说，这都是网关设计的部分。服务端渲染，本质上也是为了解决同样的问题。

## 分布式一致性解决方案

两阶段提交（2PC）和三阶段提交（3PC）都有问题，不可靠。我们必须始终牢记：网络是不可靠的，网络可能在任何时间点超时、容器可能在任何时间宕机。



### 事件通知模式

主服务完成事务后将结果用事件（消息队列）通知从服务。从服务消费完成事务后，将事件删除（否则将持续收到事件通知）。这一模式的主要问题是，消息队列与主事务如何保持一致。解决方案是主事务中增加一个本地Msg表，事件投递成功后，删除本地Msg。若事件投递失败，由消息补偿定时任务将未投递消息写入消息服务。

目前看来是比较完美的，但是这一方案对主业务有很大的侵入性。因此可以考虑将Msg持久化独立为一个服务。在开始主事务前，先将Msg置为Prepare状态，然后主事务完成后，Commit Msg。如果Prepare Msg失败，则主事务不会开始，如果Msg Prepare失败，但没有Commit Msg，则Msg服务会向主服务回调检测任务是否完成。RocketMQ实现了类似的机制。这一模式的主要缺点是需要写一个回调检查方法。

### TCC

### 补偿模式

### 半投递（RocketMQ）

### SAGAS/Seata



