---
title: 理解分布式系统的设计
tags:
---

分布式存储系统是非常复杂的，因为网络、节点都是不可靠的，而我们要在不可靠的基础上构建可靠的系统。

## 本地存储的问题

写入性能问题：写入内存、写入日志、写入最终数据结构的性能差异是很大的。

本地数据一致问题问题： 系统可能在任何时间崩溃，多条指令可能只有部分成功。我们对内存、日志、磁盘数据结构的写入可能只有部分成功，如何保证本地数据是一致的。

我们先写入日志，再写入内存，最后批量写入磁盘数据结构，任何一步失败则停止后续动作。在查询的时候，先查询内存，再查询磁盘。如果在写入日志时失败，则直接失败，服务恢复后数据一致。写入内存失败，相当于崩溃，服务恢复后从日志恢复数据。如果在写入内存成功、写入磁盘数据结构时失败。内存数据依然能够提供查询的需要，同时由同步线程定时重试，写入磁盘数据。这样我们就保证了本地数据的一致性。这里引申出一个问题：如何有效的从日志恢复数据？

如果日志量过大，重放需要很长的时间，因此我们可以使用检查点技术。在每一个检查点，我们都保证了数据的一致性，并保存了当时的一些元信息状态。当我们在数据恢复时，只需要从检查点开始进行日志重放即可。

我们在本地存储中也需要加入checksum的机制，用于防止磁盘的机械物理错误。为了防止一个小的物理错误致使整个节点的数据失效，我们也需要将本地的存储划分为不同的部分，某一部分的损坏不影响其他部分的数据。这里引申出一个问题：如何设计本地存储的分块。

我们还忽略了一个重要的问题，查询性能与写入性能，这都是直接与数据库本身的设计特点直接相关的内容，还需要考虑如何减少磁盘访问次数，如B+树，元数据表等，这里不展开。

## 分布式存储的问题

数据完整性问题： 只有冗余能够保证数据的完整性。我们需要至少2个副本才能基本保证可靠，一般而言，我们要有至少3个副本，以免两个副本同时损坏。这引申出两个问题。

如何使系统容量能线性的扩展？我们不能让两个节点的数据块分布一模一样，我们要使他们尽量的保持『正交』。假设我们有ABC三个节点，我们有1234几个数据块。我们可以 A(1,2,3),B(2,3,4),C(4,1) 类似的方式，来分布数据，这样我们在恢复数据时的性能也能得到提升。

如何保证一个强一致事务至少2个副本写入成功？

分区数据一致性问题：对于多个节点的操作可能也只有部分成功。我们如何判定某个操作是成功的。如：本地写入成功即认为成功，至少两个节点写入成功才算成功。这里引申出一个问题：网络操作有 成功、失败、超时三种状态，超时状态不能简单认为失败，要如何处理？

