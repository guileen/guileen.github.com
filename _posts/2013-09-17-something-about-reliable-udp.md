---
title: 关于UDP的一些事
layout: post
published: true
categories: 
tags: 
---

UDP协议速度更快，但不可靠，是一种无连接的协议。TCP是基于连接的协议。但是TCP并不适合不稳定的网络环境，如移动网络。 所以我们需要UDP可靠传输。

UDP可靠传输协议，有一个开源项目叫UDT，使用一种算法来达到可靠传输的目的，[The UDT Congestion Control Algorithm](http://www.jenkinssoftware.com/raknet/manual/congestioncontrol.html)。

相关协议还有RUDP(Reliable UDP)，和SRUDP(Simple Reliable UDP)。

RTP 已是视频等内容的标准。

### 对UDP丢包率影响最大的是数据包的大小。

以太网(Ethernet)数据帧的长度必须在46-1500字节之间,这是由以太网的物理特性决定的.这个1500字节被称为链路层的MTU(最大传输单元).但这并不是指链路层的长度被限制在1500字节,其实这个MTU指的是链路层的数据区.并不包括链路层的首部和尾部的18个字节.所以,事实上,这个1500字节就是网络层IP数据报的长度限制.因为IP数据报的首部为20字节,所以IP数据报的数据区长度最大为1480字节.而这个1480字节就是用来放TCP传来的TCP报文段或UDP传来的UDP数据报的.又因为UDP数据报的首部8字节,所以UDP数据报的数据区最大长度为1472字节.这个1472字节就是我们可以使用的字节数。:) 

当我们发送的UDP数据大于1472的时候会怎样呢？这也就是说IP数据报大于1500字节,大于 MTU.这个时候发送方IP层就需要分片(fragmentation).把数据报分成若干片,使每一片都小于MTU.而接收方IP层则需要进行数据报的重组.这样就会多做许多事情,而更严重的是,由于UDP的特性,当某一片数据传送中丢失时,接收方便无法重组数据报.将导致丢弃整个UDP数据报。 
因此,在普通的局域网环境下，我建议将UDP的数据控制在1472字节以下为好. 
进行Internet编程时则不同,因为Internet上的路由器可能会将MTU设为不同的值.如果我们假定MTU为1500来发送数据的,而途经的某个网络的MTU值小于1500字节,那么系统将会使用一系列的机制来调整MTU值,使数据报能够顺利到达目的地,这样就会做许多不必要的操作.鉴于 Internet上的标准MTU值为576字节,所以我建议在进行Internet的UDP编程时.最好将UDP的数据长度控件在548字节 (576-8-20)以内.

是否需要校验？这是一个问题。理论上无论TCP 还是 UDP，都是需要校验的。


### TCP链接如何保证可靠性？
 TCP的数据包中记录了序号(seq)和应答号(ack)两个字段。三次握手成功后，seq被初始化。传输过程中，TCP继续使用这个序号来标记发送的每个数据包，发送端每传送一个数据包，序列号加一。接收端每接受一个数据包，会用ACK应答哪个seq标记的数据包收到了。

  通过上述过程，TCP链接就可以保证通信的可靠性了。1. 针对于丢包或者延迟，TCP定义了重发机制。发送端监听接收端返回的ACK包，如果在一个时间窗口内发送端未能接收到ACK包，发送端就认为发送失败，重发该数据包。2. 数据包的重发机制就会导致包的重复，针对包的重复，TCP根据包的seq字段去重复。接收端接收到数据包之后，查看其seq字段，如果已经成功接收该数据包，则丢弃这个数据包。3. IP包的转发机制可能导致包的乱序，针对包的乱序，TCP同样根据包的seq字段重装数据段。保证了每个数据包能够以正确的顺序，无重复的传输到接收端，也就保证了TCP链接的传输可靠性。

### UDP可能出现的问题

因此，UDP报文可能会出现丢失、乱序、延时等问题。
